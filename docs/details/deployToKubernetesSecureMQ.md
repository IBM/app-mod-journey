# Create Liberty image that connects to a Secure MQ

- Enable MQ to be secure. 

- Get the certificate from mq (/var/mqm/qmgrs/<QM>/ssl/key.kdb) . label name below is the label that you used when created certs in step 1 above
  -   /opt/mqm/bin/runmqakm -cert -list -db key.kdb -pw passw0rd
  -   /opt/mqm/bin/runmqakm -cert -extract -db key.kdb -label ibmwebspheremqqm_mdb -file qm.arm -stashed


- Download the Migration bundle from Transformation Advisor

- Place the application binary into the target directory and remove the placeholder file

- Place the mq rar file into src/main/liberty/lib and remove the placeholder file 

- Remove the SSL and Keystore elements from the server xml file (/root/ta/src/main/liberty/config)

- In the server xml, needed to make these changes
  -   In the jmsActivation spec -  change transportType="BINDINGS_THEN_CLIENT" to transportType="CLIENT"
  -   In the jmsActivation spec - add sslCipherSuite="SSL_RSA_WITH_AES_128_CBC_SHA256"

  -   Also needed to add information about queues  (not part of the server xml collected by TA)
````
<jmsQueue id="jms/SampleMDBQueue" jndiName="jms/SampleMDBQueue"> <properties.mqJmsRa baseQueueName="Q_MDB" baseQueueManagerName="QM_MDB"/> </jmsQueue>
    <jmsQueueConnectionFactory connectionManagerRef="QueueConnMgr" jndiName="jms/SampleMDBConnectionFactory">
        <properties.ActiveMQResourceAdapter />
    </jmsQueueConnectionFactory>
````

- On the MQ machine we need to add the certs from application 
  -   Goto the openshift project and select secrets . get the tls.crt and tls.key from <application>-svc-tls-ocp  and copy these values to a file (openshift.txt)
  -   Add this to the key.kdb - /opt/mqm/bin/runmqakm -cert -add -db key.kdb -label openshift -file openshift.txt -pw passw0rd
  -   Restart the QM

- On OCP environment, create a project
  -   oc new-project sslmq


- Create a trust file called mq.p12 for example using qm.arm file that you created in step 2 above 
  -   keytool -import -alias mqcertssl -file qm.arm -keystore mq.p12 -storetype pkcs12
  -   give it a password when prompted , for example, passw0rd
  -   type 'yes' when prompted to trust this certificate

- Create a secret using the file you created in step 8 above
  -   oc create secret generic mqsecret --from-file=mq.p12

- Need to create truststore.xml file that contains the password that we defined in step 10 above and location of the mq.p12

- Create a secret for this truststore xml file
  -   oc create secret generic mqtrustfile --from-file=truststore.xml

- Once the secrets have been created, mq.p12 and truststore.xml can be deleted. 

- Build the WebSphere Liberty image
  -   podman build -t mq:latest .

- Push the image to registry (push to the OpenShift Registry)
  -   sudo podman login -u kubeadmin -p <tokenID> <openshift registry>  --tls-verify=false
  -   podman tag localhost/mq:latest default-route-openshift-image-registry.apps.tasvt.cp.fyre.ibm.com/sslmq/mq:latest
  -   sudo podman push < openshift registry >/sslmq/mq:latest --tls-verify=false

- Update the application-cr.yaml file  (see below)
  -   Add the container image
  -   Add the volume mounts for the secrets you created above

- Add in the passwords if needed from file  overlays/dev/<app>-secret.yaml
  -   Get the base64 value echo -n "passw0rd" | base64

- Deploy the application
  -   oc apply -k overlays/dev

- Check application 
  -   oc get pods 

- Click on routes and click the route for the application and add the context root for the application 



Truststore.xml   - point to where mq.p12 file
-----------------------------------------------------------
```
<server description="Default Server">
 <ssl id="defaultSSLConfig" keyStoreRef="defaultKeyStore" trustStoreRef="defaultTrustStore" trustDefaultCerts="${SEC_TLS_TRUSTDEFAULTCERTS}"/>
 <keyStore id="defaultTrustStore" location="${server.output.dir}/resources/security/mq/mq.p12" type="PKCS12" password="passw0rd" />
 <variable name="SEC_TLS_TRUSTDEFAULTCERTS" defaultValue="true"/>
</server>

``` 
Application Cr Yaml
----------------------------------------
```
# Generated by IBM TransformationAdvisor
# Tue Jan 16 16:59:19 UTC 2024
kind: WebSphereLibertyApplication
apiVersion: liberty.websphere.ibm.com/v1
metadata:
  name: samplemdbejbear
spec:
  replicas: 1
  applicationImage: default-route-openshift-image-registry.apps.tasvt.cp.fyre.ibm.com/sslmq/mq:latest
  expose: true
  volumeMounts:
    - mountPath: /config/variables
      name: samplemdbejbear-secret
      readOnly: true
    - mountPath: /opt/ibm/wlp/output/defaultServer/resources/security/mq
      name: mqsecret
      readOnly: true
    - mountPath: /config/configDropins/overrides/
      name: mqtrustfile
      readOnly: true

  volumes:
    - name: samplemdbejbear-secret
      secret:
        secretName: samplemdbejbear-secret
    - name: mqsecret
      secret:
        secretName: mqsecret
    - name: mqtrustfile
      secret:
        secretName: mqtrustfile

  envFrom:
    - configMapRef:
        name: samplemdbejbear-config
  manageTLS: true
  license:
    accept: true #You must set this value to true and add the appropriate license information. See: https://www.ibm.com/docs/en/was-liberty/core?topic=resources-webspherelibertyapplication-custom-resource#cfg-r-crd-wl__license
    #edition: IBM WebSphere Application Server
    #metric: Virtual Processor Core (VPC)
    #productEntitlementSource: IBM WebSphere Hybrid Edition
```

Working Server XML
------------------
```
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!--Generated by IBM TransformationAdvisor 3.9.0
Tue Jan 16 16:59:19 UTC 2024--><server description="Configuration generated by binaryAppScanner">
    <featureManager>
        <!--Generated by IBM TransformationAdvisor 3.9.0 to support metric integration.-->
        <feature>mpMetrics-1.1</feature>
        <!--End features generated by Transformation Advisor-->
        <!--The following features are available in all editions of Liberty.-->
        <feature>ejbLite-3.2</feature>
        <feature>transportSecurity-1.0</feature>
        <!--The following features are available in all editions of Liberty, except for Liberty Core.-->
        <feature>ejbHome-3.2</feature>
        <feature>jms-2.0</feature>
        <feature>mdb-3.2</feature>
    </featureManager>
    <!-- This configuration was migrated on 1/15/24 at 10:41:11 PM from the following location: /opt/IBM/WebSphere/AppServer/profiles/AppSrv02 -->
    <!-- The binary scanner does not support the migration of all WebSphere traditional configuration elements. Check the binary scanner documentation for the list of supported configuration elements. -->
    <applicationManager autoExpand="true"/>
    <httpEndpoint host="${httpEndpoint_host_12}" httpPort="${httpEndpoint_port_12}" httpsPort="${httpEndpoint_secure_port_12}" id="defaultHttpEndpoint"/>
    <enterpriseApplication id="SampleMDBEJBEAR.ear" location="SampleMDBEJBEAR.ear"/>
    <transaction propogatedOrBMTTranLifetimeTimeout="300"/>
     <jmsActivationSpec id="jms/SampleMDBQueueActivationSpec">
        <properties.mqJmsRa brokerCCDurSubQueue="SYSTEM.JMS.D.CC.SUBSCRIBER.QUEUE" sslCipherSuite="SSL_RSA_WITH_AES_128_CBC_SHA256" brokerCCSubQueue="SYSTEM.JMS.ND.CC.SUBSCRIBER.QUEUE" brokerControlQueue="SYSTEM.BROKER.CONTROL.QUEUE" brokerSubQueue="SYSTEM.JMS.ND.SUBSCRIBER.QUEUE" brokerVersion="1" channel="${SampleMDBQueueActivationSpec_channel}" cleanupInterval="3600000" destination="jms/SampleMDBQueue" hostName="${SampleMDBQueueActivationSpec_hostName}" poolTimeout="300000" port="${SampleMDBQueueActivationSpec_port}" queueManager="${SampleMDBQueueActivationSpec_queueManager}" sparseSubscriptions="FALSE" subscriptionDurability="Nondurable" subscriptionStore="MIGRATE" transportType="CLIENT" useJNDI="true"/>
    </jmsActivationSpec>
    <jmsQueue id="jms/SampleMDBQueue" jndiName="jms/SampleMDBQueue"> <properties.mqJmsRa baseQueueName="Q_MDB" baseQueueManagerName="QM_MDB"/> </jmsQueue>
    <jmsQueueConnectionFactory connectionManagerRef="QueueConnMgr" jndiName="jms/SampleMDBConnectionFactory">
        <properties.ActiveMQResourceAdapter />
    </jmsQueueConnectionFactory>

    <resourceAdapter id="mqJmsRa" location="${shared.config.dir}/lib/global/wmq.jmsra.rar">
        <classloader apiTypeVisibility="spec, ibm-api, api, third-party"/>
    </resourceAdapter>
    <!-- The following variables, which often differ between environments, have been extracted from the migrated configuration to allow for easy substitution. -->
    <variable defaultValue="*" name="httpEndpoint_host_12"/>
    <variable defaultValue="9080" name="httpEndpoint_port_12"/>
    <variable defaultValue="9443" name="httpEndpoint_secure_port_12"/>
    <variable defaultValue="SampleMDBEJBEAR_ear_ghettoes1Node02_NodeDefaultKeyStore_key.p12" name="NodeDefaultKeyStore_ghettoes1Node02Cell_KeyStore_ghettoes1Node02_1_location"/>
    <variable defaultValue="TLS" name="NodeDefaultSSLSettings_ghettoes1Node02Cell_SSLConfig_ghettoes1Node02_1_sslProtocol"/>
    <variable defaultValue="SampleMDBEJBEAR_ear_ghettoes1Node02_NodeDefaultTrustStore_trust.p12" name="NodeDefaultTrustStore_ghettoes1Node02Cell_KeyStore_ghettoes1Node02_2_location"/>
    <variable defaultValue="WLP.SVRCONN" name="SampleMDBQueueActivationSpec_channel"/>
    <variable defaultValue="9.46.76.40" name="SampleMDBQueueActivationSpec_hostName"/>
    <variable defaultValue="1415" name="SampleMDBQueueActivationSpec_port"/>
    <variable defaultValue="QM_MDB" name="SampleMDBQueueActivationSpec_queueManager"/>
    <!-- The following variables are used to replace sensitive data in the server.xml file for the application.
         The values for these variables were not collected because the includeSensitiveData option was not specified.
    -->
    <variable defaultValue="" name="NodeDefaultKeyStore_ghettoes1Node02Cell_KeyStore_ghettoes1Node02_1_password"/>
    <variable defaultValue="" name="NodeDefaultTrustStore_ghettoes1Node02Cell_KeyStore_ghettoes1Node02_2_password"/>
</server>
```
